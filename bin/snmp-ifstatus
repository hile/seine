#!/usr/bin/env python
"""
Show SNMP interface details
"""

import os

from seine.snmp import SNMPError,SNMP_VERSIONS 
from seine.snmp.script import SNMPScript,SNMPScriptError
from seine.snmp.devices.network.interfaces import SNMPNetworkInterfaces

DEFAULT_CACHE_PATH = os.path.join(os.getenv('HOME'),'.snmp_index.cache')

script = SNMPScript()
script.set_defaults(**{'cache_path': DEFAULT_CACHE_PATH})
script.add_option('-o','--octets',action='store_true',help='Show octet counters')
script.add_option('-a','--packets',action='store_true',help='Show packet counters')
script.add_option('-s','--summary',action='store_true',help='Show interface summary')
script.add_option('-u','--update-indexes',action='store_true',
    help='Update device interface index cache'
)
try:
    (opts,args) = script.parse_args()
except SNMPScriptError,emsg:
    script.get_usage()
    script.exit(1,emsg)

sni = SNMPNetworkInterfaces(**script.client_kwargs)
names = sni.interface_names()

if opts.update_indexes:
    sni.update_indexes()

if len(args) == 0:
    for index,details in names.items():
        print details['name'] 

for name in args:
    try:
        n = name.lower()
        index = filter(lambda x:
            n in [x['name'].lower(), x['description'].lower()],
            names.values()
        )[0]['index']
    except IndexError:
        print 'No such interface name: %s' % name
        continue

    print '\n' + names[index]['description'] 
    if not opts.summary and opts.octets:
        counters = sni.interface_octet_counters(index)[index]
        for k,v in counters.items():
            print '%20s %s' % (k,v)
    if not opts.summary and opts.packets:
        counters = sni.interface_packet_counters(index)[index]
        for k,v in counters.items():
            print '%20s %s' % (k,v)
    if opts.summary:
        details = sni.interface_details(index)
        for k in sorted(filter(lambda x: x!='description', details.keys())):
            print '%20s %s' % (k,details[k])

